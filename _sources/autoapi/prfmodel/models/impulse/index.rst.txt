prfmodel.models.impulse
=======================

.. py:module:: prfmodel.models.impulse

.. autoapi-nested-parse::

   Impulse response models.



Classes
-------

.. autoapisummary::

   prfmodel.models.impulse.TwoGammaImpulse


Functions
---------

.. autoapisummary::

   prfmodel.models.impulse.convolve_prf_impulse_response
   prfmodel.models.impulse.gamma_density


Module Contents
---------------

.. py:function:: convolve_prf_impulse_response(prf_response: prfmodel.typing.Tensor, impulse_response: prfmodel.typing.Tensor) -> prfmodel.typing.Tensor

   Convolve the encoded response from a population receptive field model with an impulse response.

   Both responses must have the same number of batches but can have different numbers of frames.

   :param prf_response: Encoded population receptive field model response. Must have shape (num_batches, num_response_frames).
   :type prf_response: Tensor
   :param impulse_response: Impulse response. Must have shape (num_batches, num_impulse_frames).
   :type impulse_response: Tensor

   :returns: Convolved response with shape (num_batches, num_response_frames).
   :rtype: Tensor

   .. rubric:: Notes

   Before convolving both responses, the `prf_response` is padded on the left side in the
   `num_frames` dimension by repeating the first value of each batch. This ensures that the output of the convolution
   has the same shape as `prf_response` and the `impulse_response` starts at every frame of the `prf_response`.

   :raises BatchDimensionError: If `prf_response` and `impulse_response` have batch (first) dimensions with different sizes.


.. py:function:: gamma_density(value: prfmodel.typing.Tensor, shape: prfmodel.typing.Tensor, rate: prfmodel.typing.Tensor, norm: bool = True) -> prfmodel.typing.Tensor

   Calculate the density of a gamma distribution.

   The distribution uses a shape and rate parameterization.
   Raises an error when evaluated at negative values.

   :param value: The values at which to evaluate the gamma distribution. Must be > 0.
   :type value: Tensor
   :param shape: The shape parameter. Must be > 0.
   :type shape: Tensor
   :param rate: The rate parameter. Must be > 0.
   :type rate: Tensor
   :param norm: Whether to compute the normalized density.
   :type norm: bool, default=True

   :returns: The density of the gamma distribution at `value`.
   :rtype: Tensor

   .. rubric:: Notes

   The unnormalized density of the gamma distribution
   with `shape` :math:`\alpha` and `rate` :math:`\lambda` is given by:

   .. math::

       f(x) = x^{\mathtt{\alpha} - 1} e^{\mathtt{\lambda} x}.

   When `norm=True`, the density is multiplied with a normalizing constant:

   .. math::

       f_{norm} = \frac{\mathtt{\lambda}^{\mathtt{\alpha}}}{\Gamma(\mathtt{\alpha})} * f(x).

   :raises ValueError: If `values`, `shape`, or `rate` are zero or negative.


.. py:class:: TwoGammaImpulse(duration: float = 32.0, offset: float = 0.0001, resolution: float = 1.0)



   Weighted difference of two gamma distributions impulse response model.

   Predicts an impulse response that is the weighted difference of two gamma distributions.
   The model has five parameters: `shape_1` and `rate_1` for the first, `shape_2` and `rate_2` for the second
   gamma distribution, and `weight` for the relative weight of the first gamma distribution.

   :param duration: The duration of the impulse response (in seconds).
   :type duration: float, default=32.0
   :param offset: The offset of the impulse response (in seconds). By default a very small offset is added to prevent infinite
                  response values at t = 0.
   :type offset: float, default=0.0001
   :param resolution: The time resultion of the impulse response (in seconds), that is the number of points per second at which the
                      impulse response function is evaluated.
   :type resolution: float, default=1.0
   :param dtype: Dtype of the impulse response.
   :type dtype: str, default="float64"

   .. rubric:: Notes

   The predicted impulse response at time :math:`t` with `shape_1` :math:`\alpha_1`, `rate_1` :math:`\lambda_1`,
   `shape_2` :math:`\alpha_2`, `rate_2` :math:`\lambda_2`, and `weight` :math:`w` is:

   .. math::

       f(t) = \hat{f}_{\text{gamma}}(t; \alpha_1, \lambda_1) - w \hat{f}_{\text{gamma}}(t; \alpha_2, \lambda_2)

   The gamma distributions are divided by their respective maximum, so that their highest peak has an amplitude of 1:

   .. math::
       \hat{f}_{\text{gamma}}(t; \alpha, \lambda) = \frac{f_{\text{gamma}}(t; \alpha, \lambda)}
       {\text{max}(f_{\text{gamma}}(t; \alpha, \lambda))}

   .. rubric:: Examples

   >>> import pandas as pd
   >>> params = pd.DataFrame({
   >>>     "shape_1": [2.0, 1.0, 1.5],
   >>>     "rate_1": [1.0, 1.0, 1.0],
   >>>     "shape_2": [1.5, 2.0, 1.0],
   >>>     "rate_2": [1.0, 1.0, 1.0],
   >>>     "weight": [0.7, 0.2, 0.5],
   >>> })
   >>> impulse_model = TwoGammaImpulse(
   >>>     duration=100.0 # 100 seconds
   >>> )
   >>> resp = impulse_model(params)
   >>> print(resp.shape) # (num_rows, duration)
   (3, 100)


   .. py:property:: parameter_names
      :type: list[str]


      Names of parameters used by the model.

      Parameter names are: `shape_1`, `rate_1`, `shape_2`, `rate_2`, `weight`.


   .. py:method:: __call__(parameters: pandas.DataFrame, dtype: str | None = None) -> prfmodel.typing.Tensor

      Predict the impulse response.

      :param parameters: Dataframe with columns containing different model parameters and rows containing parameter values
                         for different batches. Must contain the columns `shape_1`, `rate_1`, `shape_2`, `rate_2`, and `weight`.
      :type parameters: pandas.DataFrame
      :param dtype: The dtype of the prediction result. If `None` (the default), uses the dtype from
                    :func:`prfmodel.utils.get_dtype`.
      :type dtype: str, optional

      :returns: The predicted impulse response with shape `(num_batches, num_frames)` and dtype `dtype`.
      :rtype: Tensor



   .. py:property:: num_frames
      :type: int


      The total number of time frames at which the impulse response function is evaluated.


   .. py:property:: frames
      :type: prfmodel.typing.Tensor


      The time frames at which the impulse response function is evaluated.

      Time frames are linearly interpolated between `offset` and `duration` and have shape (1, `num_frames`).


